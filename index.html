<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minimal Analytics</title>
  <style>
  /*! normalize.css v8.0.1 | MIT License |   */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/charts.css/dist/charts.min.css">
  <style>
    *, *:after, *:before {
      box-sizing: border-box;
    }
    .debug * {
        outline: 1px solid red;
    }
    .contain {
      max-width: 60em;
      margin: 0 auto;
      padding-top: 2em;
      padding-bottom: 2em;
    }

    html {
      font-family: monospace;
      font-size: 14px;
    }
    body {
      overflow-y: scroll;
      /*
      background-color: #111;
      color: #fff;
      */
    }
    body > * {
      padding: 1rem;
    }
    .sticky-top {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 9000;
      box-shadow: 0 1em 2.9em #f7f7f7;
    }

    #pageviews-chart {
      --color: #222;
      height: 7rem;
      margin: 1em auto;
      /* padding-left: 3rem;
      padding-right: 3rem; */
      overflow: hidden;
    }
    @media all and (max-width: 50em) {
      #pageviews-chart {
        /* display: none; */
        padding-left: 0;
        padding-right: 0;
      }
    }
    #pageviews-chart tr:hover {
      background: #eee;
    }
    ul, ol {
      margin-left: 0;
      padding-left: 0;
    }
    li {
      display: block;
      list-style-type: none;
      padding-top: 0.25em;
      padding-bottom: 0.25em;
      word-break: break-word;
    }
    select {
      display: inline-block;
      padding: 0.5em 1em;
      margin-bottom: 2em;
    }

    .favicon {
      height: 1rem;
      width: 1rem;
      margin-right: 0.5em;
    }

    .hidden {
      display: none;
    }

    .opaque {
      opacity: 0.9;
    }


    .grid {
      display: flex;
    }

    .w-50 {
      width: 50%;
    }
    @media all and (min-width: 60em) {
      .grid-lg {
        display: flex;
      }
      .w-50-lg {
        width: 50%;
      }
    }
    .filterable {
      height: 1.3em;
      overflow: hidden;
      text-overflow: ellipsis;
      word-break: break-all;
      font-weight: bold;
      margin-bottom: 0.5em;
      padding: 0.125em 0.25em;
      /* display: block; */
      border-bottom: 1px dotted #ccc;
    }
    .filterable.active {
      background: #fe1;
    }
    .filterable:hover, .filterable:focus, .filterable:active {
      background: #fe1;
      cursor: pointer;
      text-decoration: underline;
      outline: none;
      border-bottom: 1px dotted #ccc;
      /* border: none; */
    }
    .opaque .filterable, .opaque .filterable, .opaque .filterable {
      background: #fe1;
    }
    .opaque .filterable:hover, .opaque .filterable:focus, .opaque .filterable:active {
      background: rgba(255, 123, 0, 0.1);
    }
    .select-timeframe, .select-resolution {
      cursor: pointer;
      outline: none;
      border-bottom: 1px dotted #000;
    }
    #filters {
      position: fixed;
      top: 0.5em;
      right: 0.5em;
      padding: 0.25em;
      z-index: 100;
      background-color: rgb(250,250,250);
      max-width: 40em;
      font-size: 0.8em;
    }
    @media all and (max-width: 40em) {
      #filters {
        max-width: 100%;
      }
    }
    #notice {
      border: 1px solid #000;
      padding: 1em 0.5em;
      position: relative;
      max-width: 40em;
      margin: 1em auto;
    }
    #notice > span {
      position: absolute;
      top: 0.5em;
      right: 0.5em;
    }

    details {
      margin-top: 1em;
    }

    .visitor {
      width: 1em;
      height: 1em;
      display: inline-block;
    }
    .pageview {
      margin: 0;
      padding: 0.5em 0;
      border-bottom: 1px dotted #000;
    }
    .pageview p {
      margin: 0;
      padding: 0;
    }
    .chart {
      height: 150px;
      height: 7em;
      width: 100%;
      stroke-width: 1.5;
      fill-opacity: 0.15;
      stroke-opacity: 0.8;
    }
    .charts-css.line tbody tr:first-of-type .tooltip {
      left: 6em;
    }
    .charts-css.line tbody tr:last-of-type .tooltip {
      left: -3em;
    }
    .active {
      border-bottom: 2px solid black;;
    }
    .charts-css .tooltip {
      transition: none !important;
    }
    h1, h2, h3, h4, h5, h6 {
      font-size: 1em;
    }
    .views {
      min-width: 2.5em;
      display: inline-block;
    }
  </style>
</head>
<body class="debug1">
  <div class="sticky-top1">
    <div class="grid contain">
      <div class="w-50">
        <h4>Timeframe</h4>
        <span class="select-timeframe" name="today" id="today">Today</span>
        <span class="select-timeframe" name="past-day" id="past-day">Past day</span>
        <span class="select-timeframe" name="past-week" id="past-week">Past week</span>
        <span class="select-timeframe" name="past-month" id="past-month">Past month</span>
      </div>
      <div class="w-50">
        <h4>Resolution</h4>
        <span class="select-resolution" name="hourly" id="hourly">Hourly</span>
        <span class="select-resolution" name="daily" id="daily">Daily</span>
        <span class="select-resolution" name="minutes" id="minutes">Minutes</span>
      </div>
    </div>
    
    <div id="pageviews-chart"></div>
  </div>

  <div id="filters"></div>

  <div class="grid contain">
    <div class="w-50">
      <h2>Visitors</h2>
      <div id="visitors-count"></div>
    </div>
    <div class="w-50">
      <h2>Pageviews</h2>
      <div id="pageviews-count"></div>
    </div>
    <div class="w-50">
      <h2>Live</h2>
      <div id="live"></div>
    </div>
  </div>

  <div id="notice"></div>

  <div class="grid-lg contain">
    <div class="w-50-lg" id="referrers">
      <h2>Top Referrers</h2>
      <ul id="top-referrers"></ul>
    </div>
    <div class="w-50-lg" id="pages">
      <h2>Top Pages</h2>
      <ul id="top-pages"></ul>
    </div>
  </div>

  <details id="timeline-container" class="contain"> 
    <summary>
      <h2 style="display: inline-block;">Timeline</h2>
    </summary>
    <ul id="timeline"></ul>
  </details>

  <div class="contain">
    <div class="grid-lg">
      <div class="w-50-lg">
        <h1>Web analytics for <a href="{{SITE_BASE_URL}}">{{SITE_BASE_URL}}</a></h1>
      </div>
      <div class="w-50-lg">
        <h1>Made by <a href="https://cri.dev">cri.dev</a></h1>
      </div>
    </div>
  </div>

  <div id="debug"></div>
  <script>
    ;(async () => {
      const ui = {
        $live: document.getElementById('live'),
        $timeline: document.getElementById('timeline'),
        $filters: document.getElementById('filters'),
        $pageviewsChart: document.getElementById('pageviews-chart'),
        $topPages: document.getElementById('top-pages'),
        $topReferrers: document.getElementById('top-referrers'),
        $pages: document.getElementById('pages'),
        $referrers: document.getElementById('referrers'),
        $selectTimeframe: [...document.querySelectorAll('.select-timeframe')],
        $selectResolution: [...document.querySelectorAll('.select-resolution')],
        $visitorsCount: document.getElementById('visitors-count'),
        $pageviewsCount: document.getElementById('pageviews-count'),
        $notice: document.getElementById('notice')
      }
      const state = {
        currentTimeframe: 'past-day',
        currentFilters: {resolution: 'hourly'},
        currentUrl: new URL(window.location),
        data: [],
        pages: [],
        referrers: [],
        chartData: [], 
        visitorsCount: 0,
        pageviewsCount: 0,
        live: 0
      }

      if (localStorage.ackNotice) {
        ui.$notice.remove()
      } else {
        const $closeNotice = document.createElement('span')
        $closeNotice.innerText = '[x]'
        $closeNotice.addEventListener('click', function () {
          localStorage.ackNotice = 'true'
          ui.$notice.remove()
        })
        const $noticeText = document.createElement('p')
        $noticeText.innerText = `
Click on any "Top Referrers" and "Top Pages" to filter analytics
        `.trim()
        ui.$notice.append($closeNotice)
        ui.$notice.append($noticeText)
      }


      if (['/today', '/past-day', '/past-week', '/past-month'].includes(state.currentUrl.pathname)) {
        state.currentTimeframe = state.currentUrl.pathname.substring(1)
      }
      updateResolutions(state)

      document.getElementById(state.currentTimeframe) && document.getElementById(state.currentTimeframe).classList.add('active')

      if (window.location.search) {
        const paramString = window.location.search.substring(1)
        state.currentFilters = paramString.split('&').reduce((acc, curr) => {
          const [type,value] = curr.split('=')
          return {...acc, [type]: decodeURIComponent(value)}
        }, {})
      }
      if (state.currentUrl.search.includes('resolution=')) {
        const parts = state.currentUrl.pathname.substring(1).split('=')
        state.currentFilters.resolution = parts.reduce((acc, curr, i, arr) => curr === 'resolution' ? a[i + 1] : acc, undefined)
        if (!['minutes', 'hourly', 'daily'].includes(state.currentFilters.resolution)) state.currentFilters.resolution = 'hourly'
      }

      setInterval(getAndRenderLive, 5000, state)
      updateData(state).then(() => updateUI(state))
      setInterval(() => updateData(state).then(() => updateUI(state)), 1000 * 15)

      ui.$selectTimeframe.forEach($t => {
        makeClickable($t, () => {
          ui.$selectTimeframe.forEach($t => $t.classList.remove('active'))
          $t.classList.add('active')
          filterByTimeframe($t.getAttribute('id'))
        })
        function filterByTimeframe (timeframe) {
          state.currentTimeframe = timeframe
          updateResolutions(state)
          ui.$pageviewsChart.classList.remove('hidden')
          const url = new URL(window.location);
          url.pathname = '/' + state.currentTimeframe
          url.searchParams.set('resolution', state.currentFilters);
          Object.keys(state.currentFilters).forEach(k => {
            url.searchParams.set(k, state.currentFilters[k]);
          })
          window.history.pushState({}, '', url);
          state.currentUrl = url
          
          updateData(state).then(() => updateUI(state))
        }
      })
      
      
      ui.$selectResolution.forEach($r => {
        makeClickable($r, () => {
          ui.$selectResolution.forEach($r => $r.classList.remove('active'))
          $r.classList.add('active')
          filterWithResolution($r.getAttribute('id'))
        })
        function filterWithResolution (resolution) {
          ui.$pageviewsChart.classList.remove('hidden')
          const url = new URL(window.location);
          url.searchParams.set('resolution', resolution);
          window.history.pushState({}, '', url);
          state.currentUrl = url
          state.currentFilters.resolution = resolution
          
          updateData(state).then(() => updateUI(state))
        }
      })

      function updateResolutions (state = {}) {
        if (['past-week', 'past-month'].includes(state.currentTimeframe) && ['minutes'].includes(state.currentFilters.resolution)) {
          state.currentFilters.resolution = 'hourly'
        } else {
          if (['past-day', 'today'].includes(state.currentTimeframe) && ['daily'].includes(state.currentFilters.resolution)) {
            state.currentFilters.resolution = 'hourly'
          }
        }
        ui.$selectResolution.forEach($r => {
          if (['past-day', 'today'].includes(state.currentTimeframe)) {
            if (['daily'].includes($r.getAttribute('id'))) {
              $r.classList.add('hidden')
            } else {
              $r.classList.remove('hidden')
            }
          }
          if (['past-week', 'past-month'].includes(state.currentTimeframe)) {
            if (['minutes'].includes($r.getAttribute('id'))) {
              $r.classList.add('hidden')
            } else {
              $r.classList.remove('hidden')
            }
          }
          if ($r.getAttribute('id') === state.currentFilters.resolution) {
            $r.classList.add('active')
          } else {
            $r.classList.remove('active')
          }
        })
      }

      async function getLiveVisitors () {
        const req = await window.fetch('/live')
        const live = +await req.text()
        return live
      }

      async function getAndRenderLive(state = {}) {
        const live = await getLiveVisitors()
        state.live = live
        ui.$live.innerText = live
      }


      async function updateData(state = {}) {
        let query = ''
        if (Object.keys(state.currentFilters).length > 0) {
          query = `?` + Object.keys(state.currentFilters).reduce((acc, curr) => acc.concat([`${curr}=${encodeURIComponent(state.currentFilters[curr])}`]), []).join('&')
        }
        const last1h = await window.fetch('/api/'+state.currentTimeframe + query)
        const json = await last1h.json()
        Object.assign(state, json)
        
        return json
      }

      async function updateUI ({data, pages, referrers, chartData, visitorsCount, pageviewsCount, live} = {}) {
        ui.$timeline.innerHTML = ''
        ui.$pageviewsChart.innerHTML = ''
        ui.$topPages.innerHTML = ''
        ui.$topReferrers.innerHTML = ''
        ui.$visitorsCount.innerText = visitorsCount
        ui.$pageviewsCount.innerText = pageviewsCount
        ui.$live.innerText = live


        function createPageviewElement(d) {
          const $pageview = document.createElement('li')
          $pageview.classList.add('pageview')
          const $visit = document.createElement('div')
          $visit.innerHTML = `<time>${d.d.substring(0, 19)}</time> ${d.v} <span style="background-color: ${visitorColor(d.v)}" class="visitor"></span>`
          makeClickable($visit, () => toggleFilter('v', d.v))
          $pageview.append($visit)

          const $page = document.createElement('div')
          $page.innerHTML = `<b>${d.p}</b>`
          makeClickable($page, () => toggleFilter('p', d.p))
          $pageview.append($page)

          if (d.r) {
            const $referrer = document.createElement('div')
            $referrer.innerHTML = `from <img class="favicon" src="https://icons.duckduckgo.com/ip3/${domain(d.r)}.ico"/> ${d.r}`
            makeClickable($referrer, () => toggleFilter('r', d.r))
            $pageview.append($referrer)
          }

          return $pageview
        }
        data.forEach(d => {
          const $pageview = createPageviewElement(d)
          ui.$timeline.append($pageview)
        })

        function createPageElement (d) {
          const $page = document.createElement('li')
          $page.innerHTML = `<b class="views">${d.views}</b> ${d.p}`.trim()
          makeClickable($page, () => toggleFilter('p', d.p))
          return $page
        }
        pages.slice(0, 10).forEach(d => {
          ui.$topPages.append(createPageElement(d))
        })
        if (pages.slice(10).length > 0) {
          const $morePages = document.createElement('details')
          $morePages.innerHTML = `<summary>More</summary>`
          pages.slice(10).forEach(d => {
            $morePages.append(createPageElement(d))
          })
          ui.$topPages.append($morePages)
        }
        

        function createReferrersElement (d) {
          const $referrer = document.createElement('li')
          $referrer.innerHTML = `<b class="views">${d.views}</b> <img class="favicon" src="https://icons.duckduckgo.com/ip3/${domain(d.r)}.ico"/>${d.r}`.trim()
          makeClickable($referrer, () => {
            toggleFilter('r', d.r)
          })
          return $referrer
        }
        referrers.slice(0, 10).forEach(d => {
          ui.$topReferrers.append(createReferrersElement(d))
        })
        if (referrers.slice(10).length > 0) {
          const $moreReferrers = document.createElement('details')
          $moreReferrers.innerHTML = `<summary>More</summary>`
          referrers.slice(10).forEach(d => {
            $moreReferrers.append(createReferrersElement(d))
          })
          ui.$topReferrers.append($moreReferrers)
        }

        const maxPageviews = Math.max(...chartData.map(d => d.views))

        const chartType = chartData.length < 7 ? 'column' : 'line'

        ui.$pageviewsChart.innerHTML = `
          <table class="charts-css column show-primary-axis">
            <tbody>
              ${chartData.map((d, i) => `
                <tr>
                  <td style="--start: ${i === 0 ? 0 : chartData[i - 1].views / maxPageviews}; --size: ${d.views / maxPageviews}"><span class="tooltip">${d.date.replace(':00.000Z', '')}<br>${d.views} pageviews</span> </td>
                </tr>
              `.trim()).join('')}
            </tbody>
          </table>
        `.trim()

        renderFilters(state)
      }

      function baseUrl (url) {
        if (!url) return '/'
        var a = document.createElement('a')
        a.href = url
        return 'https://' +a.hostname
      }

      function domain (url) {
        if (!url) return '/'
        var a = document.createElement('a')
        a.href = url
        return a.hostname
      }

      function toggleFilter (type, value) {
        const url = new URL(window.location);
        if (url.searchParams.has(type)) {
          url.searchParams.delete(type);
          delete state.currentFilters[type]
        } else {
          url.searchParams.set(type, value);
          state.currentFilters[type] = value
        }
        window.history.pushState({}, '', url);
        state.currentUrl = url

        updateData(state).then(() => updateUI(state))
      }

      function renderFilters (state = {}) {
        ui.$filters.innerHTML = ``
        const extendedType = {p: 'page', v: 'visitor', r: 'referrer'}
        const keys = Object.keys(state.currentFilters).filter(k => Object.keys(extendedType).includes(k))

        if (keys.length > 0) ui.$filters.innerHTML += 'Filtering by<br>'
        keys.forEach(type => {
          const value = state.currentFilters[type]
          const $filter = document.createElement('li')
          $filter.innerHTML = `[x] ${extendedType[type]}: ${value}`
          makeClickable($filter, () => toggleFilter(type))
          ui.$filters.append($filter)
        })

        ui.$referrers.classList.remove('opaque')
        ui.$pages.classList.remove('opaque')
        keys.forEach(type => {
          if (extendedType[type] === 'referrer') ui.$referrers.classList.add('opaque')
          if (extendedType[type] === 'page') ui.$pages.classList.add('opaque')
        })
      }

      function makeClickable ($el, fn) {
        $el.setAttribute('title', 'Toggle filter')
        $el.classList.add('filterable')
        $el.setAttribute('tabindex', '0')
        $el.addEventListener('click', fn)
        $el.addEventListener('keydown', e => e.keyCode === 13 && fn(e))
        return $el
      }

      function visitorColor (v) {
        return '#' + intToRGB(hashCode(v))

        // https://stackoverflow.com/questions/3426404/create-a-hexadecimal-colour-based-on-a-string-with-javascript
        function hashCode(str) { // java String#hashCode
          var hash = 0;
          for (var i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
          }
          return hash;
        } 

        function intToRGB(i){
          var c = (i & 0x00FFFFFF)
            .toString(16)
            .toUpperCase();

          return "00000".substring(0, 6 - c.length) + c;
        }
      }
    })();
  </script>
</body>
</html>